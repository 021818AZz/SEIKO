<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico</title>
    <style>
        :root {
            --primary: #1c2230;
            --secondary: #00fdfc;
            --text: #ffffff;
            --card-bg: #2a3244;
            --positive: #4CAF50;
            --negative: #F44336;
            --withdrawal: #FF9800;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--primary);
            color: var(--text);
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 100px;
        }
        
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary);
        }
        
        .back-icon {
            cursor: pointer;
            margin-right: 15px;
        }
        
        .header-content {
            flex: 1;
        }
        
        .header h1 {
            color: var(--secondary);
            margin-bottom: 5px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header p {
            margin-top: 0;
            opacity: 0.8;
            font-size: 0.9em;
        }
        
        .record-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .record-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .record-title {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .purchase-title {
            color: var(--secondary);
        }
        
        .task-title {
            color: var(--positive);
        }
        
        .withdrawal-title {
            color: var(--withdrawal);
        }
        
        .record-detail {
            font-size: 0.9em;
            margin-bottom: 5px;
            padding-left: 34px;
        }
        
        .record-date {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 10px;
            padding-left: 34px;
        }
        
        .record-value {
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
        }
        
        .positive-value {
            color: var(--positive);
        }
        
        .negative-value {
            color: var(--negative);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 253, 252, 0.3);
            border-radius: 50%;
            border-top: 4px solid rgba(0, 253, 252, 1);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #0b0e2a;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #333;
        }

        .nav div {
            text-align: center;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }

        .nav img {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .record-icon {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back-icon" onclick="window.history.back()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="#00FDFC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="header-content">
                <h1>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 13H15M9 17H12M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21Z" stroke="#00FDFC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Registros
                </h1>
                <p>Suas Atividades</p>
            </div>
        </div>
        
        <div id="records-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Carregando seu histórico...</p>
            </div>
        </div>
    </div>
    
    <!-- Navigation Bar -->
    <div class="nav">
        <div onclick="window.location.href='home.html'">
            <img src="https://i.postimg.cc/bvWWNmPF/home.png" alt="home">
            <div>Home</div>
        </div>
        <div onclick="window.location.href='produto.html'">
            <img src="https://i.postimg.cc/bwFF3mZN/product.png" alt="produto">
            <div>Produto</div>
        </div>
        <div onclick="window.location.href='carteira.html'">
            <img src="https://i.postimg.cc/3R2Sr7nd/walletactive.png" alt="carteira">
            <div>Carteira</div>
        </div>
        <div onclick="window.location.href='meu.html'">
            <img src="https://i.postimg.cc/8cB04D6q/my.png" alt="meu">
            <div>Meu</div>
        </div>
    </div>

 <script>
document.addEventListener('DOMContentLoaded', async function() {
    const API_REGISTRO_BASE = 'https://68581c8721f5d3463e572a1a.mockapi.io/Registro/';
    const API_PRO_BASE = 'https://685730c921f5d3463e54a877.mockapi.io/Pro/';
    const API_WITHDRAWAL_BASE = 'https://685839af21f5d3463e578873.mockapi.io/Retirada/';
    
    // Obtém o número de telefone do usuário do localStorage
    const userData = JSON.parse(localStorage.getItem('userData'));
    const userPhone = userData?.phone;
    
    const recordsContainer = document.getElementById('records-container');

    if (!userPhone) {
        recordsContainer.innerHTML = '<div class="record-card"><p>Usuário não logado. Redirecionando...</p></div>';
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
    }

    try {
        // Busca compras (Registro APIs 1-20) por telefone
        const purchaseRequests = [];
        for (let i = 1; i <= 20; i++) {
            purchaseRequests.push(fetch(`${API_REGISTRO_BASE}${i}?phone=${userPhone}`));
        }

        // Busca tarefas (Pro APIs 1-20) por telefone
        const taskRequests = [];
        for (let i = 1; i <= 20; i++) {
            taskRequests.push(fetch(`${API_PRO_BASE}${i}?phone=${userPhone}`));
        }

        // Busca retiradas (Withdrawal APIs 1-20) por telefone
        const withdrawalRequests = [];
        for (let i = 1; i <= 20; i++) {
            withdrawalRequests.push(fetch(`${API_WITHDRAWAL_BASE}${i}?phone=${userPhone}`));
        }

        const [purchaseResponses, taskResponses, withdrawalResponses] = await Promise.all([
            Promise.allSettled(purchaseRequests),
            Promise.allSettled(taskRequests),
            Promise.allSettled(withdrawalRequests)
        ]);

        let allRecords = [];

        // Processa compras
        for (let i = 0; i < purchaseResponses.length; i++) {
            const response = purchaseResponses[i];
            if (response.status === 'fulfilled' && response.value.ok) {
                try {
                    const purchases = await response.value.json();
                    if (Array.isArray(purchases)) {
                        purchases.forEach(purchase => {
                            // Filtra apenas compras (valores positivos)
                            if (purchase.valor > 0) {
                                allRecords.push({
                                    type: 'purchase',
                                    data: purchase,
                                    date: new Date(purchase.data || purchase.dataCompra)
                                });
                            }
                        });
                    }
                } catch (error) {
                    console.error(`Erro ao processar API de registro ${i + 1}:`, error);
                }
            }
        }

        // Processa tarefas
        for (let i = 0; i < taskResponses.length; i++) {
            const response = taskResponses[i];
            if (response.status === 'fulfilled' && response.value.ok) {
                try {
                    const tasks = await response.value.json();
                    if (Array.isArray(tasks)) {
                        tasks.forEach(task => {
                            // Só mostra se tiver totalRecebido e for maior que 0
                            if (task.totalRecebido && task.totalRecebido > 0) {
                                allRecords.push({
                                    type: 'task',
                                    data: task,
                                    date: new Date(task.ultimoPagamento || task.dataCompra)
                                });
                            }
                        });
                    }
                } catch (error) {
                    console.error(`Erro ao processar API Pro ${i + 1}:`, error);
                }
            }
        }

        // Processa retiradas
        for (let i = 0; i < withdrawalResponses.length; i++) {
            const response = withdrawalResponses[i];
            if (response.status === 'fulfilled' && response.value.ok) {
                try {
                    const withdrawals = await response.value.json();
                    if (Array.isArray(withdrawals)) {
                        withdrawals.forEach(withdrawal => {
                            allRecords.push({
                                type: 'withdrawal',
                                data: withdrawal,
                                date: new Date(withdrawal.createdAt || withdrawal.data)
                            });
                        });
                    }
                } catch (error) {
                    console.error(`Erro ao processar API de retirada ${i + 1}:`, error);
                }
            }
        }

        // Ordena todos os registros por data (mais recente primeiro)
        allRecords.sort((a, b) => b.date - a.date);

        // Exibe os registros
        displayRecords(allRecords);

    } catch (error) {
        console.error('Erro ao carregar histórico:', error);
        recordsContainer.innerHTML = '<div class="record-card"><p>Ocorreu um erro ao carregar seu histórico.</p></div>';
    }
});

// A função displayRecords permanece exatamente a mesma
function displayRecords(records) {
    const recordsContainer = document.getElementById('records-container');
    
    if (records.length === 0) {
        recordsContainer.innerHTML = '<div class="record-card"><p>Nenhum registro encontrado.</p></div>';
        return;
    }

    let html = '';
    
    records.forEach(record => {
        const date = record.date;
        const formattedDate = date.toLocaleString('pt-PT', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).replace(',', '');
        
        if (record.type === 'purchase') {
            const purchase = record.data;
            const valorFormatado = purchase.valor.toLocaleString('pt-PT', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            html += `
                <div class="record-card">
                    <div class="record-header">
                        <svg class="record-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 10H21M7 3V5M17 3V5M6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z" stroke="#00FDFC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="record-title purchase-title">Compra realizada</div>
                    </div>
                    <div class="record-detail">${purchase.nomeProduto || purchase.descricao || 'Produto não especificado'}</div>
                    <div class="record-date">${formattedDate}</div>
                    <div class="record-value negative-value">-${valorFormatado} Kz</div>
                </div>
            `;
        } else if (record.type === 'task') {
            const task = record.data;
            const valorFormatado = task.totalRecebido.toLocaleString('pt-PT', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            html += `
                <div class="record-card">
                    <div class="record-header">
                        <svg class="record-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 15V3M12 15L8 11M12 15L16 11M21 12C21 16.9706 16.9706 21 12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="record-title task-title">Rendimento recebido</div>
                    </div>
                    <div class="record-detail">${task.nome || 'Tarefa concluída'}</div>
                    <div class="record-date">${formattedDate}</div>
                    <div class="record-value positive-value">+${valorFormatado} Kz</div>
                </div>
            `;
        } else if (record.type === 'withdrawal') {
            const withdrawal = record.data;
            const valorFormatado = withdrawal.amount.toLocaleString('pt-PT', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            html += `
                <div class="record-card">
                    <div class="record-header">
                        <svg class="record-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 15V3M12 15L8 11M12 15L16 11M3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12Z" stroke="#FF9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="record-title withdrawal-title">Retirada realizada</div>
                    </div>
                    <div class="record-detail">${withdrawal.ibanDetails || 'Conta bancária'}</div>
                    <div class="record-date">${formattedDate}</div>
                    <div class="record-value negative-value">-${valorFormatado} Kz</div>
                </div>
            `;
        }
    });

    recordsContainer.innerHTML = html;
}
    </script>
</body>
</html>