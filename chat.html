<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversa com Suporte</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background-image: url('https://i.postimg.cc/ZnC4mM8f/Figma-DDSSlice-PNG69dbc20b7a67a4afca4e1baa8f9cae73.png');
      background-size: cover;
      background-position: center;
      color: white;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .back-button {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .back-button svg {
      width: 24px;
      height: 24px;
      fill: white;
      cursor: pointer;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 20px;
      text-align: center;
    }
    .chat-container {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }
    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user-message {
      background-color: #005753;
      margin-left: auto;
    }
    .admin-message {
      background-color: #003366;
      margin-right: auto;
    }
    .message-time {
      font-size: 10px;
      color: #aaa;
      margin-top: 3px;
      text-align: right;
    }
    .input-area {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #messageInput {
      flex: 1;
      padding: 12px;
      border: 2px solid #00e4e3;
      border-radius: 25px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      outline: none;
    }
    #sendButton {
      background-color: #00e4e3;
      color: black;
      border: none;
      border-radius: 25px;
      padding: 0 20px;
      cursor: pointer;
      font-weight: bold;
      height: 44px;
    }
    .loading {
      text-align: center;
      padding: 10px;
      color: #ccc;
    }
    .media-container {
      margin-top: 8px;
      max-width: 100%;
    }
    .media-image, .media-video {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
    }
    .media-audio {
      width: 100%;
      margin-top: 8px;
    }
    .attachment-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 10px;
      display: flex;
      align-items: center;
    }
    .attachment-button svg {
      width: 24px;
      height: 24px;
      fill: white;
    }
    .hidden {
      display: none;
    }
    .file-input-label {
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 8px;
      color: #ccc;
      font-style: italic;
    }
    .typing-dot {
      width: 8px;
      height: 8px;
      background-color: #ccc;
      border-radius: 50%;
      margin: 0 2px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
     /* Adicione estes novos estilos */
    .audio-recorder {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .record-button {
      background-color: #ff3d3d;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .record-button svg {
      width: 20px;
      height: 20px;
      fill: white;
    }
    .record-button.recording {
      animation: pulse 1.5s infinite;
    }
    .timer {
      font-size: 14px;
      color: white;
    }
    .audio-visualizer {
      height: 20px;
      flex-grow: 1;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      overflow: hidden;
    }
    .visualizer-bar {
      height: 100%;
      width: 2px;
      background-color: #00e4e3;
      display: inline-block;
      margin-right: 1px;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .audio-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .audio-controls button {
      padding: 5px 10px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    .send-audio {
      background-color: #00e4e3;
      color: black;
    }
    .cancel-audio {
      background-color: #ff3d3d;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="back-button" onclick="window.history.back()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
      </svg>
    </div>
    <h1>Conversa com Suporte</h1>
    
    <div class="chat-container" id="chatContainer">
      <div class="loading">Carregando mensagens...</div>
    </div>
    
  <div class="input-area">
      <button class="attachment-button" id="attachmentButton" title="Anexar arquivo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
        </svg>
      </button>
      <input type="file" id="fileInput" class="hidden" accept="image/*, video/*, audio/*">
      
      <!-- Adicione este botão de gravação de áudio -->
      <button class="attachment-button" id="audioButton" title="Gravar áudio">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2h-1v2a8 8 0 0 0 7 7.93V21H9v2h6v-2h-1v-1.07A8 8 0 0 0 20 12v-2z"/>
        </svg>
      </button>
      
      <input type="text" id="messageInput" placeholder="Digite sua mensagem...">
      <button id="sendButton">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- Adicione este modal para gravação de áudio -->
  <div id="audioModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background-color: #131927; padding: 20px; border-radius: 10px; width: 80%; max-width: 400px;">
      <div class="audio-recorder">
        <button id="recordButton" class="record-button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3z"/>
            <path d="M17 12c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-2.08c3.39-.49 6-3.39 6-6.92h-2z"/>
          </svg>
        </button>
        <div id="timer" class="timer">00:00</div>
        <div id="audioVisualizer" class="audio-visualizer"></div>
      </div>
      <audio id="audioPreview" controls style="width: 100%; margin-top: 15px; display: none;"></audio>
      <div class="audio-controls">
        <button id="sendAudioButton" class="send-audio" style="display: none;">Enviar</button>
        <button id="cancelAudioButton" class="cancel-audio">Cancelar</button>
      </div>
    </div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      // ... (mantenha todo o código existente) ...

      // Adicione estas variáveis para controle de áudio
      const audioButton = document.getElementById('audioButton');
      const audioModal = document.getElementById('audioModal');
      const recordButton = document.getElementById('recordButton');
      const timer = document.getElementById('timer');
      const audioVisualizer = document.getElementById('audioVisualizer');
      const audioPreview = document.getElementById('audioPreview');
      const sendAudioButton = document.getElementById('sendAudioButton');
      const cancelAudioButton = document.getElementById('cancelAudioButton');
      
      let mediaRecorder;
      let audioChunks = [];
      let recordingInterval;
      let seconds = 0;
      let audioContext;
      let analyser;
      let microphone;
      let dataArray;
      let canvasContext;

      // Função para formatar o tempo (mm:ss)
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
      }

      // Função para atualizar o visualizador de áudio
      function updateVisualizer() {
        if (!analyser) return;
        
        analyser.getByteFrequencyData(dataArray);
        audioVisualizer.innerHTML = '';
        
        for (let i = 0; i < 50; i++) {
          const value = dataArray[i] / 255;
          const bar = document.createElement('div');
          bar.className = 'visualizer-bar';
          bar.style.height = `${value * 100}%`;
          audioVisualizer.appendChild(bar);
        }
        
        requestAnimationFrame(updateVisualizer);
      }

      // Função para iniciar a gravação
      async function startRecording() {
        try {
          audioChunks = [];
          seconds = 0;
          timer.textContent = formatTime(seconds);
          
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          
          // Configurar o visualizador de áudio
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          microphone = audioContext.createMediaStreamSource(stream);
          microphone.connect(analyser);
          analyser.connect(audioContext.destination);
          analyser.fftSize = 64;
          dataArray = new Uint8Array(analyser.frequencyBinCount);
          updateVisualizer();
          
          mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
          };
          
          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPreview.src = audioUrl;
            audioPreview.style.display = 'block';
            sendAudioButton.style.display = 'block';
            
            // Parar o stream de mídia
            stream.getTracks().forEach(track => track.stop());
          };
          
          mediaRecorder.start();
          recordButton.classList.add('recording');
          
          // Atualizar o timer
          recordingInterval = setInterval(() => {
            seconds++;
            timer.textContent = formatTime(seconds);
          }, 1000);
          
        } catch (error) {
          console.error('Erro ao acessar microfone:', error);
          alert('Não foi possível acessar o microfone. Verifique as permissões.');
        }
      }

      // Função para parar a gravação
      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
          clearInterval(recordingInterval);
          recordButton.classList.remove('recording');
        }
      }

      // Função para enviar o áudio
      async function sendAudio() {
        if (audioChunks.length === 0) {
          alert('Nenhum áudio gravado.');
          return;
        }
        
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        
        try {
          // Converter o blob para base64
          const reader = new FileReader();
          reader.readAsDataURL(audioBlob);
          
          reader.onload = async () => {
            const base64Audio = reader.result;
            
            const newMessage = {
              phone: userPhone,
              text: 'Áudio enviado',
              sender: 'user',
              createdAt: new Date().toISOString(),
              read: false,
              mediaType: 'audio',
              mediaData: base64Audio
            };
            
            // Mostrar mensagem localmente imediatamente
            displayMedia('', 'audio', base64Audio, false);
            
            // Enviar mensagem para a API
            const response = await fetch('https://685a82e29f6ef9611156b6cd.mockapi.io/Conversas/1', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(newMessage)
            });
            
            if (!response.ok) {
              throw new Error('Erro ao enviar áudio');
            }
            
            // Fechar o modal e recarregar mensagens
            audioModal.style.display = 'none';
            loadMessages();
          };
          
        } catch (error) {
          console.error('Erro ao enviar áudio:', error);
          alert('Erro ao enviar áudio. Tente novamente.');
        }
      }

      // Event Listeners para o áudio
      audioButton.addEventListener('click', () => {
        audioModal.style.display = 'flex';
      });
      
      recordButton.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          stopRecording();
        } else {
          startRecording();
        }
      });
      
      sendAudioButton.addEventListener('click', sendAudio);
      
      cancelAudioButton.addEventListener('click', () => {
        stopRecording();
        audioModal.style.display = 'none';
        audioPreview.style.display = 'none';
        sendAudioButton.style.display = 'none';
      });

      // ... (mantenha o resto do código existente) ...
    });
  </script>
</body>
</html>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Obter userData do localStorage
      const userDataString = localStorage.getItem('userData');
      if (!userDataString) {
        alert('Por favor, faça login novamente.');
        window.location.href = 'index.html';
        return;
      }

      const userData = JSON.parse(userDataString);
      const userPhone = userData.phone || '';
      const chatContainer = document.getElementById('chatContainer');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const attachmentButton = document.getElementById('attachmentButton');
      const fileInput = document.getElementById('fileInput');

      // Função para formatar data/hora
      function formatDateTime(date) {
        return new Date(date).toLocaleString('pt-BR');
      }

      // Função para determinar o tipo de mídia
      function getMediaType(file) {
        if (file.type.startsWith('image/')) {
          return 'image';
        } else if (file.type.startsWith('video/')) {
          return 'video';
        } else if (file.type.startsWith('audio/')) {
          return 'audio';
        }
        return null;
      }

      // Função para exibir mídia no chat
      function displayMedia(message, mediaType, mediaData, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'admin-message'}`;
        
        let mediaContent = '';
        if (mediaType === 'image') {
          mediaContent = `<img src="${mediaData}" class="media-image" alt="Imagem enviada">`;
        } else if (mediaType === 'video') {
          mediaContent = `<video controls class="media-video"><source src="${mediaData}"></video>`;
        } else if (mediaType === 'audio') {
          mediaContent = `<audio controls class="media-audio"><source src="${mediaData}"></audio>`;
        }
        
        messageDiv.innerHTML = `
          <div>${message}</div>
          <div class="media-container">${mediaContent}</div>
          <div class="message-time">${formatDateTime(new Date().toISOString())}</div>
        `;
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Função para exibir mensagem de texto
      function displayTextMessage(text, isUser, createdAt) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'admin-message'}`;
        messageDiv.innerHTML = `
          <div>${text}</div>
          <div class="message-time">${formatDateTime(createdAt)}</div>
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Função para mostrar indicador de digitação
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message admin-message typing-indicator';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
          Suporte está digitando
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        `;
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Função para esconder indicador de digitação
      function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      // Função para carregar mensagens
      async function loadMessages() {
        chatContainer.innerHTML = '<div class="loading">Carregando mensagens...</div>';
        
        try {
          // Buscar todas as conversas
          const response = await fetch('https://685a82e29f6ef9611156b6cd.mockapi.io/Conversas/1');
          if (!response.ok) throw new Error('Erro ao cargar mensagens');
          
          const conversations = await response.json();
          const messages = Array.isArray(conversations) ? conversations : [conversations];
          
          // Filtrar apenas mensagens deste usuário
          const userMessages = messages.filter(msg => msg.phone === userPhone);
          
          chatContainer.innerHTML = '';
          
          if (userMessages.length === 0) {
            chatContainer.innerHTML = '<div class="loading">Nenhuma mensagem encontrada</div>';
            return;
          }
          
          // Ordenar mensagens por data
          userMessages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
          
          // Exibir mensagens
          userMessages.forEach(msg => {
            if (msg.mediaType && msg.mediaData) {
              // Mensagem com mídia
              const messageDiv = document.createElement('div');
              messageDiv.className = `message ${msg.sender === 'admin' ? 'admin-message' : 'user-message'}`;
              
              let mediaContent = '';
              if (msg.mediaType === 'image') {
                mediaContent = `<img src="${msg.mediaData}" class="media-image" alt="Imagem enviada">`;
              } else if (msg.mediaType === 'video') {
                mediaContent = `<video controls class="media-video"><source src="${msg.mediaData}"></video>`;
              } else if (msg.mediaType === 'audio') {
                mediaContent = `<audio controls class="media-audio"><source src="${msg.mediaData}"></audio>`;
              }
              
              messageDiv.innerHTML = `
                <div>${msg.text || ''}</div>
                <div class="media-container">${mediaContent}</div>
                <div class="message-time">${formatDateTime(msg.createdAt)}</div>
              `;
              chatContainer.appendChild(messageDiv);
            } else {
              // Mensagem de texto normal
              displayTextMessage(msg.text, msg.sender !== 'admin', msg.createdAt);
            }
          });
          
          // Rolagem automática para a última mensagem
          chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (error) {
          console.error('Erro ao carregar mensagens:', error);
          chatContainer.innerHTML = '<div class="loading">Erro ao carregar mensagens</div>';
        }
      }

      // Função para converter arquivo para base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
        });
      }

      // Função para enviar mensagem
      async function sendMessage() {
        const text = messageInput.value.trim();
        const file = fileInput.files[0];
        
        if (!text && !file) return;
        
        try {
          let mediaType = null;
          let mediaData = null;
          
          if (file) {
            mediaType = getMediaType(file);
            if (!mediaType) {
              alert('Tipo de arquivo não suportado. Envie apenas imagens, vídeos ou áudios.');
              return;
            }
            mediaData = await fileToBase64(file);
          }
          
          const newMessage = {
            phone: userPhone,
            text: text,
            sender: 'user',
            createdAt: new Date().toISOString(),
            read: false,
            mediaType: mediaType,
            mediaData: mediaData
          };
          
          // Mostrar mensagem localmente imediatamente
          if (mediaType && mediaData) {
            displayMedia(text || '', mediaType, mediaData, true);
          } else if (text) {
            displayTextMessage(text, true, newMessage.createdAt);
          }
          
          // Mostrar indicador de digitação do suporte (simulado)
          setTimeout(() => {
            showTypingIndicator();
            setTimeout(hideTypingIndicator, 2000);
          }, 1000);
          
          // Limpar campos
          messageInput.value = '';
          fileInput.value = '';
          
          // Enviar mensagem para a API
          const response = await fetch('https://685a82e29f6ef9611156b6cd.mockapi.io/Conversas/1', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(newMessage)
          });
          
          if (!response.ok) {
            throw new Error('Erro ao enviar mensagem');
          }
          
          // Recarregar mensagens após envio
          loadMessages();
        } catch (error) {
          console.error('Erro ao enviar mensagem:', error);
          alert('Erro ao enviar mensagem. Tente novamente.');
        }
      }

      // Eventos
      sendButton.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
      });
      
      attachmentButton.addEventListener('click', function() {
        fileInput.click();
      });
      
      fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const mediaType = getMediaType(file);
          
          if (!mediaType) {
            alert('Tipo de arquivo não suportado. Envie apenas imagens, vídeos ou áudios.');
            fileInput.value = '';
            return;
          }
          
          // Adiciona uma visualização do arquivo selecionado
          messageInput.placeholder = `Arquivo selecionado: ${file.name}`;
        }
      });

      // Carregar mensagens inicialmente
      loadMessages();
      
      // Atualizar mensagens a cada 10 segundos
      setInterval(loadMessages, 10000);
    });
  </script>
</body>
</html>